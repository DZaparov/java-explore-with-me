DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS categories CASCADE;
DROP TABLE IF EXISTS locations CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS requests CASCADE;
DROP TABLE IF EXISTS compilations CASCADE;
DROP TABLE IF EXISTS compilations CASCADE;

CREATE TABLE IF NOT EXISTS users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(512) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS locations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  lat FLOAT NOT NULL,
  lon FLOAT NOT NULL
);

CREATE TABLE IF NOT EXISTS events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title VARCHAR(120) NOT NULL,
  description VARCHAR(7000),
  annotation VARCHAR(2000) NOT NULL,
  category_id BIGINT REFERENCES categories (id) ON DELETE CASCADE,
  created_on TIMESTAMP WITHOUT TIME ZONE,
  published_on TIMESTAMP WITHOUT TIME ZONE,
  event_date TIMESTAMP WITHOUT TIME ZONE,
  user_id BIGINT REFERENCES users (id) ON DELETE CASCADE,
  location_id BIGINT REFERENCES locations (id) ON DELETE CASCADE,
  state VARCHAR(20),
  participant_limit INT,
  confirmed_requests INT,
  paid BOOL NOT NULL,
  request_moderation BOOL NOT NULL,
  views INT
);

CREATE TABLE IF NOT EXISTS requests (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  event_id BIGINT REFERENCES events (id) ON DELETE CASCADE,
  requester_id BIGINT REFERENCES users (id) ON DELETE CASCADE,
  created TIMESTAMP WITHOUT TIME ZONE,
  status VARCHAR(20)
);

CREATE TABLE IF NOT EXISTS compilations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title VARCHAR(120) NOT NULL,
  pinned BOOL NOT NULL
);

CREATE TABLE IF NOT EXISTS compilation_event (
    compilation_id BIGINT REFERENCES compilations (id) ON DELETE CASCADE,
    event_id BIGINT REFERENCES events (id) ON DELETE CASCADE,
    PRIMARY KEY(compilation_id, event_id)
);